---
## Author
author:
  name: Калашникова Ольга Сергеевна
  orcid: 0000-0002-0877-7063
  email: 1132231846@rudn.ru
  affiliation:
    - name: Российский университет дружбы народов
      country: Российская Федерация
      postal-code: 117198
      city: Москва
      address: ул. Миклухо-Маклая, д. 6

## Title
title: "Отчёт по лабораторной работе 8"
license: "CC BY"
---

# Цель работы

Приобретение практических навыков по установке и конфигурированию SMTP-
сервера.

# Задание

1. Установите на виртуальной машине server SMTP-сервер postfix (см. раздел 8.4.1).

2. Сделайте первоначальную настройку postfix при помощи утилиты postconf, задав отправку писем не на локальный хост, а на сервер в домене (см. раздел 8.4.2).

3. Проверьте отправку почты с сервера и клиента (см. раздел 8.4.3).

4. Сконфигурируйте Postfix для работы в домене. Проверьте отправку почты с сервера и клиента (см. раздел 8.4.4).

5. Напишите скрипт для Vagrant, фиксирующий действия по установке и настройке Postfix во внутреннем окружении виртуальной машины server. Соответствующим образом внесите изменения в Vagrantfile (см. раздел 8.4.5).

# Выполнение лабораторной работы

## Установка Postfix

На виртуальной машине server войдём под нашим пользователем и откроем терминал. Перейдём в режим суперпользователя с помощью команды sudo -i ([рис. @fig-001]).

![Переходим в режим суперпользователя](image/1.png){#fig-001 width=70%}

Установим необходимые для работы пакеты при помощи команд dnf -y install postfix и dnf -y install s-nail ([рис. @fig-002]).

![Установка пакетов](image/2.png){#fig-002 width=70%}

Сконфигурируем межсетевой экран, разрешив работать службе протокола SMTP (команды firewall-cmd --add-service=smtp, firewall-cmd --add-service=smtp --permanent, firewall-cmd --list-services) ([рис. @fig-003]).

![Конфигурация межсетевого экрана](image/3.png){#fig-003 width=70%}

Восстановим контекст безопасности в SELinux: restorecon -vR /etc ([рис. @fig-004]).

![Восстановление контекста безопасности в SELinux](image/4.png){#fig-004 width=70%}

Запустим Postfix при помощи команд systemctl enable postfix и systemctl start postfix ([рис. @fig-005]).

![Запуск Postfix](image/5.png){#fig-005 width=70%}

## Изменение параметров Postfix с помощью postconf

Первоначальную настройку Postfix осуществиv, используя postconf. Для просмотра списка текущих настроек Postfix введём postconf ([рис. @fig-006]).

![postconf](image/6.png){#fig-006 width=70%}

Посмотрим текущее значение параметра myorigin с помощью команды postconf myorigin ([рис. @fig-007]).

![postconf myorigin](image/7.png){#fig-007 width=70%}

Посмотрим текущее значение параметра mydomain при помощи команды postconf mydomain. Указано mydomain = oskalashnikova.net ([рис. @fig-008]).

![postconf mydomain](image/8.png){#fig-008 width=70%}

Заменим значение параметра myorigin на значение параметра mydomain командой postconf -e 'myorigin = $mydomain' ([рис. @fig-009]).

![Замена значения myorigin на значение mydomain](image/9.png){#fig-009 width=70%}

Повторите команду postconf myorigin, чтобы убедиться, что замена параметра была произведена. ([рис. @fig-010]).

![Проверка](image/10.png){#fig-010 width=70%}

Проверим корректность содержания конфигурационного файла main.cf: postfix check ([рис. @fig-011]).

![Проверка корректности содержания конфигурационного файла main.cf](image/11.png){#fig-011 width=70%}

Перезагрузим (перечитаем) конфигурационные файлы Postfix с помощью команды systemctl reload postfix ([рис. @fig-012]).

![Перезагрузка конфигурационных файлов Postfix](image/12.png){#fig-012 width=70%}

Просмотрим все параметры с значением, отличным от значения по умолчанию с помощью команды postconf -n ([рис. @fig-013]).

![Все параметры с значением, отличным от значения по умолчанию](image/13.png){#fig-013 width=70%}

Зададим жёстко значение домена postconf -e 'mydomain = oskalashnikova.net' ([рис. @fig-014]).

![Изменение значения домена](image/14.png){#fig-014 width=70%}

Отключим IPv6 в списке разрешённых в работе Postfix протоколов и оставим только IPv4: postconf inet_protocols и postconf -e 'inet_protocols = ipv4' ([рис. @fig-015]).

![Отключение IPv6 в списке разрешённых в работе Postfix протоколов](image/15.png){#fig-015 width=70%}

Перезагрузите конфигурацию Postfix с помощью команд postfix check и systemctl reload postfix ([рис. @fig-016]).

![Перезагрузка конфигурацию Postfix](image/16.png){#fig-016 width=70%}

## Проверка работы Postfix

На сервере под учётной записью пользователя отправим себе письмо, используя утилиту mail с помощью команды echo .| mail -s test1 oskalashnikova@server.oskalashnikova.net ([рис. @fig-017]).

![Отправка письма на сервере](image/17.png){#fig-017 width=70%}

На втором терминале запустим мониторинг работы почтовой службы и посмотрите, что произошло с сообщением (tail -f /var/log/maillog). Код возврата dsn=2.0.0 указывает на успешную доставку, статус status=sent подтверждает отправку, фраза delivered to mailbox прямо указывает на доставку в почтовый ящик, сообщение удалено из очереди почтовой системы, что происходит только после успешной доставки. ([рис. @fig-018]).

![Проверка доставки письма 1](image/18.png){#fig-018 width=70%}

Дополнительно посмотрим содержание каталога /var/spool/mail на предмет того, появился ли там каталог вашего пользователя с отправленным письмом ([рис. @fig-019]).

![Проверка доставки письма 2](image/19.png){#fig-019 width=70%}

На виртуальной машине client войдём под пользователем и откроем терминал. Перейдём в режим суперпользователя (sudo -i)  ([рис. @fig-020]).

![Переходим в режим суперпользователя на клиенте](image/20.png){#fig-020 width=70%}

На клиенте установим необходимые для работы пакеты (dnf -y install postfix и dnf -y install s-nail) ([рис. @fig-021]).

![Установка необходимых для работы пакетов](image/21.png){#fig-021 width=70%}

Отключим IPv6 в списке разрешённых в работе Postfix протоколов и оставим только IPv4 (postconf inet_protocols и postconf -e 'inet_protocols = ipv4') ([рис. @fig-022]).

![Отключение IPv6 в списке разрешённых в работе Postfix протоколов на клиенте](image/22.png){#fig-022 width=70%}

На клиенте запустим Postfix (systemctl enable postfix, systemctl start postfix) ([рис. @fig-023]).

![Запуск Postfix на клиенте](image/23.png){#fig-023 width=70%}

На клиенте под учётной записью пользователя аналогичным образом отправим себе второе письмо, используя утилиту mail. ([рис. @fig-024]).

![Отправка письма с клиента](image/24.png){#fig-024 width=70%}

Посмотрим результат мониторинга почтовой службы на сервере при отправке сообщения с клиента. Код ошибки DSN=4.4.1 (Коды 4.x.x указывают на временные ошибки доставки) в отличие от успешного кода 2.0.0 при отправке с сервера, статус "deferred" - сообщение отложено, а не доставлено, "Connection refused" - прямое указание на проблему сети/сервиса, клиент не может установить соединение с почтовым сервером на порту 25, "relay=none" - не удалось найти релей для доставки сообщения ([рис. @fig-025]).

![Мониторинг почтовой службы](image/25.png){#fig-025 width=70%}

На сервере в конфигурации Postfix посмотрим значения параметров сетевых интерфейсов inet_interfaces (postconf inet_interfaces) и сетевых адресов mynetworks (postconf mynetworks) ([рис. @fig-026]).

![Значения параметров сетевых интерфейсов и сетевых адресов](image/26.png){#fig-026 width=70%}

Разрешим Postfix прослушивать соединения не только с локального узла, но и с других интерфейсов сети - postconf -e 'inet_interfaces = all' ([рис. @fig-027]).

![Разрешение прослушивать соединения с других интерфейсов сети](image/27.png){#fig-027 width=70%}

Добавим адрес внутренней сети, разрешив таким образом пересылку сообщений между узлами сети - postconf -e 'mynetworks = 127.0.0.0/8, 192.168.0.0/16' ([рис. @fig-028]).

![Добавление адреса внутренней сети](image/28.png){#fig-028 width=70%}

Перезагрузим конфигурацию Postfix и перезапустите Postfix (postfix check, systemctl reload postfix, systemctl stop postfix, systemctl start postfix) ([рис. @fig-029]).

![Перезагрузка конфигурацию и перезапуск Postfix](image/29.png){#fig-029 width=70%}

Повторим отправку сообщения с клиента. ([рис. @fig-030]).

![Повторная отправка сообщения с клиента](image/30.png){#fig-030 width=70%}

Посмотрим результат мониторинга почтовой службы на сервере при отправке сообщения с клиента. Как мы видим сообщение отправлено (Код возврата DSN=2.0.0 указывает на успешную доставку, статус "sent" - прямое подтверждение отправки сообщения) ([рис. @fig-031]).

![Проверка](image/31.png){#fig-031 width=70%}

## Конфигурация Postfix для домена

С клиента отправим письмо на свой доменный адрес (echo .| mail -s test2 oskalashnikova@oskalashnikova.net) ([рис. @fig-032]).

![Отправка сообщения с клиента](image/32.png){#fig-032 width=70%}

Запустим мониторинг работы почтовой службы и посмотрим, что произошло с вашим сообщением (tail -f /var/log/maillog). Сообщение успешно доставлено как мы видим по тем параметрам которые были описаны мною ранее ([рис. @fig-033]).

![Проверка отправки сообщения с клиента](image/33.png){#fig-033 width=70%}

Дополнительно посмотрим, какие сообщения ожидают в очереди на отправление postqueue -p ([рис. @fig-034]).

![Смотрим сообщения в очереди на отправку](image/34.png){#fig-034 width=70%}

Для настройки возможности отправки сообщений не на конкретный узел сети, а на доменный адрес пропишем MX-запись с указанием имени почтового сервера mail.oskalashnikova.net в файле прямой DNS-зоны ([рис. @fig-035]).

![Изменения файла прямой DNS-зоны](image/35.png){#fig-035 width=70%}

Теперь сделаем это в файле обратной DNS-зоны ([рис. @fig-036]).

![Изменения файла обратной DNS-зоны](image/36.png){#fig-036 width=70%}

В конфигурации Postfix добавим домен в список элементов сети, для которых данный сервер является конечной точкой доставки почты (postconf -e 'mydestination = $myhostname, localhost.$mydomain, localhost,$mydomain') ([рис. @fig-037]).

![Добавление домена в список элементов сети](image/37.png){#fig-037 width=70%}

Перезагрузим конфигурацию Postfix с помощью команд postfix check и systemctl reload postfix ([рис. @fig-038]).

![Перезагрузка конфигурацию Postfix](image/38.png){#fig-038 width=70%}

Восстановим контекст безопасности в SELinux с помощью команд restorecon -vR /etc и restorecon -vR /var/named ([рис. @fig-039]).

![Восстановление контекст безопасности в SELinux](image/39.png){#fig-039 width=70%}

Перезапустим DNS с помощью команды systemctl restart named ([рис. @fig-040]).

![Перезапуск DNS](image/40.png){#fig-040 width=70%}

Попробуем отправить сообщения, находящиеся в очереди на отправление с помощью команды postqueue -f  ([рис. @fig-041]).

![Отправка сообщений, находящихся в очереди на отправление](image/41.png){#fig-041 width=70%}

Проверим отправку почты с клиента на доменный адрес. ([рис. @fig-042]).

![Проверка](image/42.png){#fig-042 width=70%}

## Внесение изменений в настройки внутреннего окружения виртуальной машины

На виртуальной машине server перейдём в каталог для внесения изменений в настройки внутреннего окружения /vagrant/provision/server/ ([рис. @fig-043]).

![Переход в нужный каталог](image/43.png){#fig-043 width=70%}

Заменим конфигурационные файлы DNS-сервера( cd /vagrant/provision/server/dns/var/named, cp -R /var/named/* /vagrant/provision/server/dns/var/named )  ([рис. @fig-044]).

![Замена конфигурационных файлов DNS-сервера](image/44.png){#fig-044 width=70%}

В каталоге /vagrant/provision/server создадим исполняемый файл mail.sh (переходим в каталог cd /vagrant/provision/server, создаём скрипт touch mail.sh, chmod +x mail.sh) ([рис. @fig-045]).

![Создание исполняемого файла mail.sh](image/45.png){#fig-045 width=70%}

Пишем в файле необходимый скрипт ([рис. @fig-046]).

![Скрипт](image/46.png){#fig-046 width=70%}

На виртуальной машине client перейдём в каталог для внесения изменений в настройки внутреннего окружения /vagrant/provision/client/ ([рис. @fig-047]).

![Переход в нужный каталог](image/47.png){#fig-047 width=70%}

В каталоге /vagrant/provision/client создадим исполняемый файл mail.sh (touch mail.sh, chmod +x mail.sh) ([рис. @fig-048]).

![Создание исполняемого файла mail.sh](image/48.png){#fig-048 width=70%}

Пишем в файле необходимый скрипт ([рис. @fig-049]).

![Скрипт](image/49.png){#fig-049 width=70%}

Для отработки созданного скрипта во время загрузки виртуальной машины server в конфигурационном файле Vagrantfile добавляем в разделе конфигурации для сервера необходимые данные ([рис. @fig-050]).

![Изменение файла Vagrantfile раздел сервер](image/50.png){#fig-050 width=70%}

Для отработки созданного скрипта во время загрузки виртуальной машины client
в конфигурационном файле Vagrantfile добавляем в разделе конфигурации для клиента необходимые данные ([рис. @fig-051]).

![Изменение файла Vagrantfile раздел клиент](image/51.png){#fig-051 width=70%}

# Выводы

В ходе выполнения лабораторной работы были получены практические навыки по установке и конфигурированию SMTP-сервера.
