---
## Author
author:
  name: Калашникова Ольга Сергеевна
  orcid: 0000-0002-0877-7063
  email: 1132231846@rudn.ru
  affiliation:
    - name: Российский университет дружбы народов
      country: Российская Федерация
      postal-code: 117198
      city: Москва
      address: ул. Миклухо-Маклая, д. 6

## Title
title: "Отчёт по лабораторной работе 7"
license: "CC BY"
---

# Цель работы

Получить навыки настройки межсетевого экрана в Linux в части переадресации портов и настройки Masquerading.

# Задание

1. Настройте межсетевой экран виртуальной машины server для доступа к серверу по протоколу SSH не через 22-й порт, а через порт 2022 (см. разделы 7.4.1 и 7.4.2).

2. Настройте Port Forwarding на виртуальной машине server (см. разделы 7.4.3).

3. Настройте маскарадинг на виртуальной машине server для организации доступа клиента к сети Интернет (см. раздел 7.4.3).

4. Напишите скрипт для Vagrant, фиксирующий действия по расширенной настройке межсетевого экрана. Соответствующим образом внести изменения в Vagrantfile (см. раздел 7.4.4).

# Выполнение лабораторной работы

## Создание пользовательской службы firewalld

На виртуальной машине server входим под моим пользователем и открываем терминал. Перейдим в режим суперпользователя при помощи команды sudo -i ([рис. @fig-001]).

![Переходим в режим суперпользователя](image/1.png){#fig-001 width=70%}

На основе существующего файла описания службы ssh создаём файл с собственным описанием при помощи команды cp /usr/lib/firewalld/services/ssh.xml /etc/firewalld/services/ssh-custom.xml и переходим в каталог с файлом cd /etc/firewalld/services/ ([рис. @fig-002]).

![Создание файла ssh-custom.xml](image/2.png){#fig-002 width=70%}

Посмотрим содержимое файла службы при помощи команды cat /etc/firewalld/services/ssh-custom.xml ([рис. @fig-003]).

![Содержимое файла службы](image/3.png){#fig-003 width=70%}

1. "?xml version="1.0" encoding="utf-8"?" Объявление XML-документа, указывает версию XML (1.0) и кодировку символов (UTF-8).

2. "service" Корневой элемент, определяющий службу firewalld. Все параметры службы заключаются в этот тег.

3. "short SSH /short" Краткое имя службы, отображаемое в инструментах управления firewalld (например, firewall-cmd --list-services).

4. "description.../description" Подробное описание службы. Используется для документации и пояснения назначения службы. Может содержать развёрнутый текст.

5. "port protocol="tcp" port="22"/" Определяет порт и протокол, связанные со службой:

- protocol="tcp" — указывает протокол (TCP или UDP).

- port="22" — номер порта, который будет открыт при включении службы.

Открываем файл описания службы на редактирование и заменяем порт 22 на новый порт (2022) <port protocol="tcp" port="2022"/>. В этом же файле скорректируем описание службы для демонстрации, указывая, что это модифицированный файл службы. ([рис. @fig-004]).

![Редактирование файла службы](image/4.png){#fig-004 width=70%}

Смотрим список доступных FirewallD служб с помощью команды firewall-cmd --get-services. Новая служба ещё не отображается в списке. ([рис. @fig-005]).

![Смотрим список доступных FirewallD служб](image/5.png){#fig-005 width=70%}

Перегрузим правила межсетевого экрана с сохранением информации о состоянии (firewall-cmd --reload) и вновь выведем на экран список служб (firewall-cmd --get-services), а также список активных служб (firewall-cmd --list-services). Созданная нами служба отображается в списке доступных для
FirewallD служб, но не активирована. ([рис. @fig-006]).

![Перегрузка правил межсетевого экрана](image/6.png){#fig-006 width=70%}

Добавим новую службу в FirewallD с помощью команды firewall-cmd --add-service=ssh-custom и выведем на экран список активных служб при помощи firewall-cmd --list-services ([рис. @fig-007]).

![Добавление новой службы в FirewallD](image/7.png){#fig-007 width=70%}

Перегрузим правила межсетевого экрана с сохранением информации о состоянии при помощи команд firewall-cmd --add-service=ssh-custom --permanent и firewall-cmd --reload ([рис. @fig-008]).

![Перегрузка правил межсетевого экрана](image/8.png){#fig-008 width=70%}

## Перенаправление портов

Организуем на сервере переадресацию с порта 2022 на порт 22 с помощью команды firewall-cmd --add-forward-port=port=2022:proto=tcp:toport=22 ([рис. @fig-009]).

![Переадресация с порта 2022 на порт 22](image/9.png){#fig-009 width=70%}

На клиенте попробуем получить доступ по SSH к серверу через порт 2022 с помощью команды ssh -p 2022 user@server.oskalashnikova.net ([рис. @fig-010]).

![Получение доступа по SSH к серверу](image/10.png){#fig-010 width=70%}

## Настройка Port Forwarding и Masquerading

На сервере посмотрим, активирована ли в ядре системы возможность перенаправления IPv4-пакетов пакетов (sysctl -a | grep forward) ([рис. @fig-011]).

![Отключенное перенаправление IPv4-пакетов на сервере](image/11.png){#fig-011 width=70%}

Включим перенаправление IPv4-пакетов на сервере при помощи команды echo "net.ipv4.ip_forward = 1" > /etc/sysctl.d/90-forward.conf и проверим с помощью sysctl -p /etc/sysctl.d/90-forward.conf ([рис. @fig-012]).

![Включенное перенаправление IPv4-пакетов на сервере](image/12.png){#fig-012 width=70%}

Включим маскарадинг на сервере firewall-cmd --zone=public --add-masquerade --permanent и перезагрузим firewall-cmd --reload ([рис. @fig-013]).

![Включение маскарадинга на сервере](image/13.png){#fig-013 width=70%}

На клиенте проверяем доступность выхода в Интернет ([рис. @fig-014]).

![Интернет на клиенте работает](image/14.png){#fig-014 width=70%}

## Внесение изменений в настройки внутреннего окружения виртуальной машины

На виртуальной машине server перейдём в каталог для внесения изменений в настройки внутреннего окружения /vagrant/provision/server/, создадим в нём каталог firewall, в который поместим в соответствующие подкаталоги конфигурационные файлы FirewallD ([рис. @fig-015]).

![Перемещение файлов](image/15.png){#fig-015 width=70%}

В каталоге /vagrant/provision/server создайте файл firewall.sh ([рис. @fig-016]).

![Создание файла firewall.sh](image/16.png){#fig-016 width=70%}

Пропишем в файле firewall.sh заданный скрипт ([рис. @fig-017]).

![Скрипт](image/17.png){#fig-017 width=70%}

Для отработки созданного скрипта во время загрузки виртуальной машины server в конфигурационном файле Vagrantfile добавляем в разделе конфигурации для сервера следующие строки ([рис. @fig-018]).

![Добавление строк в Vagrantfile](image/18.png){#fig-018 width=70%}

# Выводы

В ходе выполнения данной лабораторной работы были получены навыки настройки межсетевого экрана в Linux в части переадресации портов и настройки Masquerading.

# Список литературы{.unnumbered}

::: {#refs}
:::
