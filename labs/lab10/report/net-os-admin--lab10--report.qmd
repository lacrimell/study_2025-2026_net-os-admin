---
## Author
author:
  name: Калашникова Ольга Сергеевна
  email: 1132231846@rudn.ru
  affiliation:
    - name: Российский университет дружбы народов
      country: Российская Федерация
      postal-code: 117198
      city: Москва
      address: ул. Миклухо-Маклая, д. 6

## Title
title: "Отчёт по лабораторной работе № 10"
license: "CC BY"
---

# Цель работы

Приобретение практических навыков по конфигурированию SMTP-сервера в части настройки аутентификации.

# Задание

1. Настройте Dovecot для работы с LMTP (см. раздел 10.4.1).

2. Настройте аутентификацию посредством SASL на SMTP-сервере (см. раздел 10.4.2).

3. Настройте работу SMTP-сервера поверх TLS (см. раздел 10.4.3).

4. Скорректируйте скрипт для Vagrant, фиксирующий действия расширенной настройки SMTP-сервера во внутреннем окружении виртуальной машины server (см.раздел 10.4.4)

# Выполнение лабораторной работы

## Настройка LMTP в Dovecote

На виртуальной машине server войдём под пользователем и откроем терминал. Перейдём в режим суперпользователя при помощи команды sudo -i ([рис. @fig-001]).

![Переход в режим суперпользователя](image/1.png){#fig-001 width=70%}

В дополнительном терминале запустиv мониторинг работы почтовой службы: tail -f /var/log/maillog ([рис. @fig-002]).

![Мониторинг работы почтовой службы](image/2.png){#fig-002 width=70%}

Добавим в список протоколов, с которыми может работать Dovecot, протокол LMTP. Для этого в файле /etc/dovecot/dovecot.conf укажем protocols = imap pop3 lmtp ([рис. @fig-003]).

![Добавления протокола LMTP](image/3.png){#fig-003 width=70%}

Настроим в Dovecot сервис lmtp для связи с Postfix. Для этого в файле /etc/dovecot/conf.d/10-master.conf заменим определение сервиса lmtp на следующую запись, которая определяет расположение файла с описанием прослушиваемого unix-сокета, а также задаёт права доступа к нему и определяет принадлежность к группе и пользователю postfix ([рис. @fig-004]).

![Настройка в Dovecot сервиса lmtp](image/4.png){#fig-004 width=70%}

Переопределим в Postfix с помощью postconf передачу сообщений не на прямую, а через заданный unix-сокет при помощи команды postconf -e 'mailbox_transport = lmtp:unix:private/dovecot-lmtp' ([рис. @fig-005]).

![Передача сообщений через заданный unix-сокет ](image/5.png){#fig-005 width=70%}

В файле /etc/dovecot/conf.d/10-auth.conf зададим формат имени пользователя для аутентификации в форме логина пользователя без указания домена: auth_username_format = %Ln ([рис. @fig-006]).

![Формат имени пользователя для аутентификации](image/6.png){#fig-006 width=70%}

Перезапустим Postfix(systemctl restart postfix) и Dovecot(systemctl restart dovecot) ([рис. @fig-007]).

![Перезапуск Postfix и Dovecot](image/7.png){#fig-007 width=70%}

Из-под учётной записи своего пользователя отправим письмо с клиента: echo .| mail -s "LMTP test" oskalashnikova@oskalashnikova.net  ([рис. @fig-008]).

![Отправка письма с клиента](image/8.png){#fig-008 width=70%}

Пояснения по содержанию логов при мониторинге почтовой службы ([рис. @fig-009]).

![Логи при мониторинге почтовой службы](image/9.png){#fig-009 width=70%}

postfix/qmgr[1988]: 7E001207F13B: from=<double-bounce@oskalashnikova.net> - Postfix взял письмо из очереди для обработки

postfix/local[5661]: 7£001207F13B: passing <oskalashnikova@oskalashnikova.net> to transport=Imtp - Postfix передает письмо для локального пользователя oskalashnikova через LMTP транспорт

dovecot [1569]: Imtp(5664): Connect from local - Dovecot принимает соединение через LMTP протокол

postfix/Imtp[5663]: 7£001207F13B: to=<oskalashnikova@oskalashnikova.net>, relay-server.oskalashnikova.net[private/dovecot-lmtp], status=deliverable (250 2.1.5 OK) - Письмо успешно доставлено через LMTP в почтовый ящик пользователя

postfix/qmgr[1988]: 7£001207F13B: removed - Письмо удалено из очереди Postfix (т.к. доставлено)

dovecot [1569]: Imtp(5664): Disconnect from local: Logged out - LMTP сессия завершена

На сервере просмотрим почтовый ящик пользователя MAIL=~/Maildir/ mail. Как мы видим, отправленное с клиента письмо доставлено в почтовый ящик на сервере ([рис. @fig-010]).

![Почтовый ящик пользователя](image/10.png){#fig-010 width=70%}

## Настройка SMTP-аутентификации

В файле /etc/dovecot/conf.d/10-master.conf определите службу аутентификации пользователей ([рис. @fig-011]).

![Определим службу аутентификации пользователей](image/11.png){#fig-011 width=70%}

service auth { - Объявление службы аутентификации Dovecot, отвечающей за проверку учетных данных пользователей

unix_listener /var/spool/postfix/private/auth { - Создание UNIX-сокета для связи с Postfix, расположенного в chroot-окружении Postfix

group = postfix - Назначение группы postfix для сокета, чтобы процессы Postfix имели к нему доступ

user = postfix - Назначение пользователя postfix владельцем сокета для совместимости с процессами Postfix

mode = 0660 - Установка прав доступа: чтение и запись для владельца и группы, запрет доступа для остальных

} - Закрытие блока настроек первого сокета

unix_listener auth-userdb { - Создание внутреннего сокета для доступа к базе данных пользователей Dovecot

mode = 0600 - Строгие права доступа: только владелец может читать и записывать

user = dovecot - Назначение пользователя dovecot владельцем сокета для защиты пользовательских данных

} - Закрытие блока настроек второго сокета

**} - Завершение конфигурации службы аутентификации

Для Postfix зададим тип аутентификации SASL для smtpd и путь к соответствующему unix-сокету: postconf -e 'smtpd_sasl_type = dovecot' и postconf -e 'smtpd_sasl_path = private/auth  ([рис. @fig-012]).

![Редактирование Postfix](image/12.png){#fig-012 width=70%}

Настроим Postfix для приёма почты из Интернета только для обслуживаемых сервером пользователей или для произвольных пользователей локальной машины (имеется в виду локальных пользователей сервера), обеспечивая тем самым запрет на использование почтового сервера в качестве SMTP relay для спам-рассылок (порядок указания опций имеет значение): postconf -e 'smtpd_recipient_restrictions = reject_unknown_recipient_domain, permit_mynetworks, reject_non_fqdn_recipient, reject_unauth_destination, reject_unverified_recipient, permit' ([рис. @fig-013]).

![Настройка Postfix](image/13.png){#fig-013 width=70%}

postconf -e 'smtpd_recipient_restrictions = - Настройка ограничений для получателей почты - критически важный параметр для защиты от спама

reject_unknown_recipient_domain, - Отклонять письма, если домен получателя не существует в DNS (защита от несуществующих доменов)

permit_mynetworks, - Разрешить релей для отправки с доверенных сетей (определенных в mynetworks)

reject_non_fqdn_recipient, - Отклонять письма, если адрес получателя не является полным доменным именем (FQDN)

reject_unauth_destination, - Блокировать релей - запрещать пересылку писем для доменов, не указанных в mydestination или relay_domains

reject_unverified_recipient, - Отклонять письма, если получатель не существует на сервере (проверка существования ящика)

permit' - Разрешить все остальные случаи, которые прошли предыдущие проверки

В настройках Postfix ограничим приём почты только локальным адресом SMTP-сервера сети: postconf -e 'mynetworks = 127.0.0.0/8' ([рис. @fig-014]).

![Ограничение приёма почты только локальным адресом SMTP-сервера сети](image/14.png){#fig-014 width=70%}

Для проверки работы аутентификации временно запустим SMTP-сервер (порт 25) с возможностью аутентификации. Для этого редактируем файл /etc/postfix/master.cf ([рис. @fig-015]).

![Редактируем файл /etc/postfix/master.cf](image/15.png){#fig-015 width=70%}

Перезапустим Postfix(systemctl restart postfix) и Dovecot(systemctl restart dovecot) ([рис. @fig-016]).

![Перезапуск Postfix и Dovecot](image/16.png){#fig-016 width=70%}

На клиенте установите telnet с помощью команды dnf -y install telnet ([рис. @fig-017]).

![Установка telnet](image/17.png){#fig-017 width=70%}

На клиенте получим строку для аутентификации ([рис. @fig-018]).

![Cтрока для аутентификации](image/18.png){#fig-018 width=70%}

Подключимся на клиенте к SMTP-серверу посредством telnet (telnet server.user.net 25). Протестируем соединение, введя EHLO test. Проверим авторизацию и после завершим сессию telnet на клиенте ([рис. @fig-019]).

![Подключение на клиенте к SMTP-серверу посредством telnet ](image/19.png){#fig-019 width=70%}

## Настройка SMTP over TLS

Настроим на сервере TLS, воспользовавшись временным сертификатом Dovecot. Предварительно скопируем необходимые файлы сертификата и ключа из каталога /etc/pki/dovecot в каталог /etc/pki/tls/ в соответствующие подкаталоги (чтобы не было проблем с SELinux). Сконфигурируем Postfix, указав пути к сертификату и ключу, а также к каталогу для хранения TLS-сессий и уровень безопасности  ([рис. @fig-020]).

![Настройка на сервере TLS](image/20.png){#fig-020 width=70%}

Для того чтобы запустить SMTP-сервер на 587-м порту, отредактируем файл /etc/postfix/master.cf ([рис. @fig-021]).

![Редактирование файла /etc/postfix/master.cf](image/21.png){#fig-021 width=70%}

Настроим межсетевой экран, разрешив работать службе smtp-submission с помощью последовательности команд firewall-cmd --get-services, firewall-cmd --add-service=smtp-submission, firewall-cmd --add-service=smtp-submission --permanent, firewall-cmd --reload ([рис. @fig-022]).

![Настройка межсетевого экрана](image/22.png){#fig-022 width=70%}

Перезапустим Postfix (systemctl restart postfix) ([рис. @fig-023]).

![Перезапуск Postfix](image/23.png){#fig-023 width=70%}

На клиенте подключимся к SMTP-серверу через 587-й порт посредством openssl (openssl s_client -starttls smtp -crlf -connect server.oskalashnikova.net:587) ([рис. @fig-024]).

![Подключение к SMTP-серверу через 587-й порт](image/24.png){#fig-024 width=70%}

Протестируем подключение по telnet (EHLO test) и проверим аутентификацию ([рис. @fig-025]).

![Проверка](image/25.png){#fig-025 width=70%}

Проверим корректность отправки почтовых сообщений с клиента посредством почтового клиента Evolution, предварительно скорректировав настройки учётной записи, а именно для SMTP-сервера укажем порт 587, STARTTLS и обычный пароль ([рис. @fig-026]).

![Корректировка настройки учётной записи](image/26.png){#fig-026 width=70%}

Пишем сообщение и отправляем ([рис. @fig-027]).

![Сообщение](image/27.png){#fig-027 width=70%}

Вводим пароль который мы указали ([рис. @fig-028]).

![Ввод пароля](image/28.png){#fig-028 width=70%}

Проверяем доставку сообщения ([рис. @fig-029]).

![Сообщение доставлено](image/29.png){#fig-029 width=70%}

## Внесение изменений в настройки внутреннего окружения виртуальной машины

На виртуальной машине server перейдём в каталог для внесения изменений в настройки внутреннего окружения /vagrant/provision/server/. В соответствующие подкаталоги поместим конфигурационные файлы Dovecot и Postfix ([рис. @fig-030]).

![Перемещение конфигурационных файлов](image/30.png){#fig-030 width=70%}

Внесём соответствующие изменения по расширенной конфигурации SMTP-сервера в файл /vagrant/provision/server/mail.sh ([рис. @fig-031]).

![Внесение изменений в файл /vagrant/provision/server/mail.sh](image/31.png){#fig-031 width=70%}

Внесём изменения в файл /vagrant/provision/client/mail.sh, добавив установку telnet ([рис. @fig-032]).

![Внесение изменений в файл /vagrant/provision/client/mail.sh](image/32.png){#fig-032 width=70%}

# Выводы

В ходе выполнения лабораторной работы были приобретены практические навыки по конфигурированию SMTP-сервера в части настройки аутентификации.
