---
## Author
author:
  name: Калашникова Ольга Сергеевна
  email: 1132231846@rudn.ru
  affiliation:
    - name: Российский университет дружбы народов
      country: Российская Федерация
      postal-code: 117198
      city: Москва
      address: ул. Миклухо-Маклая, д. 6

## Title
title: "Отчёт по лабораторной работе № 15"
license: "CC BY"
---

# Цель работы

Получение навыков по работе с журналами системных событий.

# Задание

1. Настройте сервер сетевого журналирования событий (см. раздел 15.4.1).

2. Настройте клиент для передачи системных сообщений в сетевой журнал на сервере (см. раздел 15.4.2).

3. Просмотрите журналы системных событий с помощью нескольких программ (см.раздел 15.4.3). При наличии сообщений о некорректной работе сервисов исправьте ошибки в настройках соответствующих служб.

4. Напишите скрипты для Vagrant, фиксирующие действия по установке и настройке сетевого сервера журналирования (см. раздел 15.4.4).

# Выполнение лабораторной работы

## Настройка сервера сетевого журнала

На сервере переключимся на пользователя root и перейдём в каталог конфигурации rsyslog: ```cd /etc/rsyslog.d``` ([рис. @fig-001]).

![Переход в каталог конфигурации rsyslog](image/1.png){#fig-001 width=70%}

Создадим файл конфигурации для сетевого журналирования: ```touch netlog-server.conf``` ([рис. @fig-001]).

Откроем файл для редактирования и добавим следующие строки для включения приёма сообщений по TCP-порту 514: ```$ModLoad imtcp```, ```$InputTCPServerRun 514``` ([рис. @fig-002]).

![Настройка приёма сообщений по TCP](image/2.png){#fig-002 width=70%}

Перезапустим службу rsyslog для применения изменений: ```systemctl restart rsyslog``` ([рис. @fig-003]).

![Перезапуск службы rsyslog](image/3.png){#fig-003 width=70%}

Проверим, что служба прослушивает TCP-порт 514: ```lsof -i :514``` или ```ss -tlnp | grep 514```. На скриншоте видно, что сервер готов принимать соединения по TCP-порту 514 ([рис. @fig-004]).

![Проверка открытого порта TCP 514](image/4.png){#fig-004 width=70%}

Настроим межсетевой экран для разрешения входящих соединений по TCP-порту 514: ```firewall-cmd --add-port=514/tcp```, ```firewall-cmd --add-port=514/tcp --permanent``` ([рис. @fig-005]).

![Настройка межсетевого экрана](image/5.png){#fig-005 width=70%}

## Настройка клиента сетевого журнала

На клиенте переключимся на пользователя root и перейдём в каталог конфигурации rsyslog: ```cd /etc/rsyslog.d``` ([рис. @fig-006]).

![Переход в каталог конфигурации rsyslog на клиенте](image/6.png){#fig-006 width=70%}

Создадим файл конфигурации для клиента сетевого журналирования: ```touch netlog-client.conf``` ([рис. @fig-006]).

Откроем файл для редактирования и добавим строку для перенаправления всех системных сообщений на сервер журналирования по TCP-порту 514: ```*.* @@server.oskalashnikova.net:514``` ([рис. @fig-007]).

![Настройка перенаправления сообщений на сервер](image/7.png){#fig-007 width=70%}

Перезапустим службу rsyslog на клиенте для применения изменений: ```systemctl restart rsyslog``` ([рис. @fig-008]).

![Перезапуск службы rsyslog на клиенте](image/8.png){#fig-008 width=70%}

## Просмотр журнала

На сервере проверим работу сетевого журналирования, просмотрев журнал системных сообщений: ```tail -f /var/log/messages```. В логах видны сообщения с именем хоста `server`, что подтверждает работу локального журналирования ([рис. @fig-009]).

![Просмотр журнала на сервере](image/9.png){#fig-009 width=70%}

На сервере также просмотрим запущенные процессы с помощью графического монитора системы: ```gnome-system-monitor``` ([рис. @fig-010]).

![Просмотр процессов в gnome-system-monitor](image/10.png){#fig-010 width=70%}

Попробуем установить просмотрщик журналов через стандартный менеджер пакетов. Сначала установим `multitail`: ```dnf -y install multitail``` ([рис. @fig-011]).

![Установка multitail](image/11.png){#fig-011 width=70%}

Запустим multitail для просмотра журналов, но у меня он не работал ([рис. @fig-012]).

![Запуск multitail](image/12.png){#fig-012 width=70%}

При установке `lnav` через стандартные репозитории возникли проблемы с зависимостями и компиляцией. Для решения этой проблемы загрузим `lnav` с официального сайта и установим вручную. После установки `lnav` запустим его для просмотра журналов: ```lnav``` ([рис. @fig-013]).

![Установка и запуск lnav](image/13.png){#fig-013 width=70%}

В `lnav` видны сообщения как с сервера (`server`), так и с клиента (`client`), что подтверждает успешную настройку сетевого журналирования. Видны сообщения о процессах VBoxClient с обоих хостов ([рис. @fig-014]).

![Просмотр журналов в lnav](image/14.png){#fig-014 width=70%}

Для сравнения, на клиенте также проверим локальный журнал: ```tail -f /var/log/messages```. На клиенте видны только сообщения от локальных процессов, что подтверждает, что сообщения успешно пересылаются на сервер ([рис. @fig-015]).

![Просмотр журнала на клиенте](image/15.png){#fig-015 width=70%}

## Внесение изменений в настройки внутреннего окружения виртуальных машин

На виртуальной машине server перейдем в каталог для внесения изменений в настройки и создадим структуру каталогов: ```cd /vagrant/provision/server```, ```mkdir -p /vagrant/provision/server/netlog/etc/rsyslog.d``` ([рис. @fig-016]).

![Создание структуры каталогов на сервере](image/16.png){#fig-016 width=70%}

Скопируем конфигурационный файл сервера: ```cp -R /etc/rsyslog.d/netlog-server.conf /vagrant/provision/server/netlog/etc/rsyslog.d``` ([рис. @fig-016]).

Создадим исполняемый скрипт настройки для сервера: ```touch netlog.sh```, ```chmod +x netlog.sh``` ([рис. @fig-017]).

![Создание скрипта настройки на сервере](image/17.png){#fig-017 width=70%}

Добавим в скрипт следующий код:([рис. @fig-018]).

```bash
#!/bin/bash
echo "Provisioning script $0"
echo "Copy configuration files"
cp -R /vagrant/provision/server/netlog/etc/* /etc
restorecon -vR /etc
echo "Configure firewall"
firewall-cmd --add-port=514/tcp
firewall-cmd --add-port=514/tcp --permanent
echo "Start rsyslog service"
systemctl restart rsyslog
``` 

![Содержимое скрипта настройки сервера](image/18.png){#fig-018 width=70%}

На виртуальной машине client выполним аналогичные действия: ```cd /vagrant/provision/client```, ```mkdir -p /vagrant/provision/client/netlog/etc/rsyslog.d``` ([рис. @fig-019]).

![Создание структуры каталогов на клиенте](image/19.png){#fig-019 width=70%}

Скопируем конфигурационный файл клиента: ```cp -R /etc/rsyslog.d/netlog-client.conf /vagrant/provision/client/netlog/etc/rsyslog.d/``` ([рис. @fig-019]).

Создадим исполняемый скрипт настройки для клиента: ```touch netlog.sh```, ```chmod +x netlog.sh``` ([рис. @fig-021]).

![Создание скрипта настройки на клиенте](image/21.png){#fig-021 width=70%}

Добавим в скрипт клиента следующий код:([рис. @fig-020]).

```bash
#!/bin/bash
echo "Provisioning script $0"
echo "Install needed packages"
dnf -y install lnav
echo "Copy configuration files"
cp -R /vagrant/provision/client/netlog/etc/* /etc
restorecon -VR /etc
echo "Start rsyslog service"
systemctl restart rsyslog
``` 

![Содержимое скрипта настройки клиента](image/20.png){#fig-020 width=70%}

В конфигурационном файле Vagrantfile добавим вызовы созданных скриптов для сервера ([рис. @fig-022]) и клиента ([рис. @fig-023]):

```
server.vm.provision "server netlog",
type: "shell",
preserve_order: true,
path: "provision/server/netlog.sh"

client.vm.provision "client netlog",
type: "shell",
preserve_order: true,
path: "provision/client/netlog.sh"
```
![Содержимое в файле Vagrantfile сервера](image/22.png){#fig-022 width=70%}

![Содержимое в файле Vagrantfile клиента](image/23.png){#fig-023 width=70%}

## Контрольные вопросы

1. **Какой модуль rsyslog вы должны использовать для приёма сообщений от journald?**
   - Для приёма сообщений от journald следует использовать модуль `imjournal`.

2. **Как называется устаревший модуль, который можно использовать для включения приёма сообщений журнала в rsyslog?**
   - Устаревший модуль называется `imuxsock`.

3. **Чтобы убедиться, что устаревший метод приёма сообщений из journald в rsyslog не используется, какой дополнительный параметр следует использовать?**
   - Следует использовать параметр `$OmitLocalLogging off` или проверить, что модуль `imuxsock` не загружен.

4. **В каком конфигурационном файле содержатся настройки, которые позволяют вам настраивать работу журнала?**
   - Основные настройки находятся в файле `/etc/rsyslog.conf`, а дополнительные — в файлах каталога `/etc/rsyslog.d/`.

5. **Каким параметром управляется пересылка сообщений из journald в rsyslog?**
   - Пересылка управляется параметром `ForwardToSyslog` в файле `/etc/systemd/journald.conf`.

6. **Какой модуль rsyslog вы можете использовать для включения сообщений из файла журнала, не созданного rsyslog?**
   - Для этого можно использовать модуль `imfile`.

7. **Какой модуль rsyslog вам нужно использовать для пересылки сообщений в базу данных MariaDB?**
   - Для пересылки сообщений в MariaDB используется модуль `ommysql`.

8. **Какие две строки вам нужно включить в rsyslog.conf, чтобы позволить текущему журнальному серверу получать сообщения через TCP?**
   - `$ModLoad imtcp`
   - `$InputTCPServerRun 514`

9. **Как настроить локальный брандмауэр, чтобы разрешить приём сообщений журнала через порт TCP 514?**
   - Использовать команды:
     ```bash
     firewall-cmd --add-port=514/tcp
     firewall-cmd --add-port=514/tcp --permanent
     firewall-cmd --reload
     ```
# Выводы 

В ходе выполннения лабораторной работы были получены навыки по работе с журналами системных событий.
